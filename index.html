<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>线上实时投票与反馈</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background-color:#f4f7f6;color:#333;margin:0;padding:20px;display:flex;justify-content:center;align-items:flex-start;min-height:100vh}
        .container{width:100%;max-width:800px;background:#fff;padding:30px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);box-sizing:border-box}
        h1,h2{color:#0056b3;text-align:center;border-bottom:2px solid #f0f0f0;padding-bottom:15px;margin-top:0}
        .poll-section,.feedback-section,.results-section{margin-bottom:35px}
        .poll-option{margin:12px 0;font-size:1.1em;display:flex;align-items:center}
        .poll-option input[type="radio"]{margin-right:10px;transform:scale(1.2)}
        textarea{width:100%;box-sizing:border-box;padding:12px;border:1px solid #ccc;border-radius:8px;font-size:1em;margin-top:10px;transition:border-color .3s}
        textarea:focus{border-color:#007bff;outline:none}
        button{display:block;width:100%;padding:14px;background:linear-gradient(45deg,#007bff,#0056b3);color:#fff;border:none;border-radius:8px;font-size:1.2em;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s}
        button:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,123,255,.4)}
        .result-bar{background-color:#e9ecef;border-radius:8px;margin:10px 0;overflow:hidden}
        .result-bar div{background-color:#28a745;color:#fff;padding:10px;white-space:nowrap;text-align:left;box-sizing:border-box;transition:width .6s cubic-bezier(.25,1,.5,1)}
        #wordcloud-container{width:100%;height:400px;border:2px dashed #d0d0d0;border-radius:8px;margin-top:10px;position:relative;display:flex;justify-content:center;align-items:center}
        .placeholder-text{color:#aaa;font-size:1.2em}
        #qrcode{padding:20px;text-align:center}
        #qrcode img{max-width:150px;border:1px solid #eee}
        h3{text-align:center;color:#555}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>线上实时投票与反馈</h1>
        <div id="qrcode">
            <h3>手机扫描二维码参与</h3>
        </div>

        <div class="poll-section">
            <h2>你对本次活动的整体感觉如何？</h2>
            <form id="poll-form">
                <div class="poll-option"><input type="radio" id="option1" name="feeling" value="非常好"><label for="option1">🎉 非常好</label></div>
                <div class="poll-option"><input type="radio" id="option2" name="feeling" value="不错"><label for="option2">👍 不错</label></div>
                <div class="poll-option"><input type="radio" id="option3" name="feeling" value="一般"><label for="option3">🙂 一般</label></div>
                <div class="poll-option"><input type="radio" id="option4" name="feeling" value="有待改进"><label for="option4">🤔 有待改进</label></div>
            </form>
        </div>

        <div class="feedback-section">
            <h2>请留下宝贵意见：</h2>
            <textarea id="feedback-text" rows="5" placeholder="请在这里输入文字..."></textarea>
        </div>

        <button onclick="submitFeedback()">提交投票和反馈</button>

        <div class="results-section">
            <h2>实时投票结果</h2>
            <div id="poll-results"><p>正在从服务器加载数据...</p></div>
        </div>

        <div class="feedback-section">
            <h2>反馈意见词云</h2>
            <div id="wordcloud-container"><p class="placeholder-text">暂无反馈</p></div>
        </div>
    </div>

       <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ==================================================================
        // 请确保您的 Firebase 配置代码在这里，并且格式正确
        // ==================================================================
        const firebaseConfig = {
  apiKey: "AIzaSyCf8mv55m8ZNIZ19mJwBweVd1V-e7DGlAg",
  authDomain: "my-live-vote-f1d26.firebaseapp.com",
  databaseURL: "https://my-live-vote-f1d26-default-rtdb.firebaseio.com",
  projectId: "my-live-vote-f1d26",
  storageBucket: "my-live-vote-f1d26.firebasestorage.app",
  messagingSenderId: "881093976847",
  appId: "1:881093976847:web:79b39e5c4b697c93d2d47a"
};

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 数据库引用
        const pollRef = database.ref('poll');
        const feedbackRef = database.ref('feedback');

        function updatePollResults(pollData) {
            const resultsContainer = document.getElementById('poll-results');
            resultsContainer.innerHTML = '';
            const totalVotes = Object.values(pollData).reduce((s, c) => s + c, 0);

            if (totalVotes === 0) {
                resultsContainer.innerHTML = '<p>暂无投票数据。</p>';
                return;
            }
            const options = ['非常好', '不错', '一般', '有待改进']; // 确保顺序
            options.forEach(option => {
                const count = pollData[option] || 0;
                const percentage = totalVotes === 0 ? 0 : ((count / totalVotes) * 100).toFixed(1);
                const resultBar = document.createElement('div');
                resultBar.className = 'result-bar';
                resultBar.innerHTML = `<div style="width: ${percentage}%;">${option}: ${count}票 (${percentage}%)</div>`;
                resultsContainer.appendChild(resultBar);
            });
        }

        function generateWordCloud(feedbackData) {
            const container = document.getElementById('wordcloud-container');
            container.innerHTML = '';
            const allText = Object.values(feedbackData || {}).join(' ');
            if (allText.trim() === '') {
                container.innerHTML = '<p class="placeholder-text">暂无反馈</p>';
                return;
            }
            const words = allText.match(/[\u4e00-\u9fa5a-zA-Z]+/g) || [];
            const wordFrequencies = {};
            words.forEach(word => { if (word.length > 1) { wordFrequencies[word] = (wordFrequencies[word] || 0) + 1; } });
            const list = Object.entries(wordFrequencies).map(([text, weight]) => [text, weight * 10]);

            if (list.length > 0) {
                WordCloud(container, { list: list, gridSize: 10, weightFactor: 3, fontFamily: '微软雅黑, sans-serif', color: 'random-dark', backgroundColor: '#fff', minSize: 12 });
            } else {
                container.innerHTML = '<p class="placeholder-text">没有足够有效的词语</p>';
            }
        }
        
        function submitFeedback() {
            const selectedOption = document.querySelector('input[name="feeling"]:checked');
            if (!selectedOption) {
                alert('请选择一个投票选项！');
                return;
            }
            
            const voteValue = selectedOption.value;
            const feedbackText = document.getElementById('feedback-text').value.trim();

            // 1. 更新投票计数 (使用事务确保数据安全)
            pollRef.child(voteValue).transaction(currentCount => (currentCount || 0) + 1);

            // 2. 如果有反馈文本，则推送到列表
            if (feedbackText) {
                feedbackRef.push(feedbackText);
            }
            
            document.getElementById('feedback-text').value = '';
            selectedOption.checked = false;
            alert('感谢您的反馈！');
        }

        // 实时监听数据库变化
        pollRef.on('value', (snapshot) => {
            const data = snapshot.val() || { '非常好': 0, '不错': 0, '一般': 0, '有待改进': 0 };
            updatePollResults(data);
        });

        feedbackRef.on('value', (snapshot) => {
            const data = snapshot.val();
            generateWordCloud(data);
        });
        
        // 生成二维码 (如果需要)
        window.onload = () => {
             const qrCodeContainer = document.getElementById('qrcode');
             if (qrCodeContainer) { // 检查容器是否存在
                const pageUrl = window.location.href;
                const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(pageUrl)}`;
                const qrImg = document.createElement('img');
                qrImg.src = qrApiUrl;
                qrCodeContainer.appendChild(qrImg);
             }
        };
    </script>
</body>
</html>
