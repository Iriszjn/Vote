<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MBPTS Tech Journey - 综合数据导出</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px 40px; background-color: #f8f9fa; color: #333; } 
        .container { max-width: 1200px; margin: 0 auto; } 
        h1 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 10px; } 
        button { font-size: 1.2em; padding: 12px 25px; margin-right: 15px; border-radius: 8px; border: none; cursor: pointer; background-color: #007bff; color: white; transition: background-color 0.2s; } 
        button:hover { background-color: #0056b3; } 
        button:disabled { cursor: not-allowed; background-color: #aaa; } 
        #status { margin-top: 20px; font-size: 1.1em; font-style: italic; color: #555; } 
        .data-section { margin-top: 30px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; } 
        h2 { margin-top: 0; color: #333; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; } 
        table { width: 100%; border-collapse: collapse; margin-top: 15px; } 
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; } 
        th { background-color: #f2f2f2; }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>MBPTS Tech Journey 综合数据导出工具</h1>
        <button id="fetch-btn">获取并生成报告 / Fetch & Generate Report</button>
        <p id="status">请点击按钮开始。 / Click the button to start.</p>
        <!-- Sections will be populated by JS -->
    </div>

    <script src="//cdn.jsdelivr.net/npm/leancloud-storage/dist/av-live-query-min.js"></script>
    <script>
        AV.init({
            appId: "Slv3fGdSSxRZxOzM5la2ZCyD-gzGzoHsz",
            appKey: "XcUAt5yfUPWQlEpLBdXLcJHW",
            serverURL: "https://slv3fgds.lc-cn-n1-shared.com"
        });

        const fetchBtn = document.getElementById('fetch-btn');
        const statusText = document.getElementById('status');
        const container = document.querySelector('.container');

        async function generateReport() {
            fetchBtn.disabled = true;
            statusText.textContent = '正在获取所有数据... / Fetching all data...';

            try {
                const query = (className) => new AV.Query(className).limit(1000).descending('createdAt').find();
                
                const [satis, words, interests, trainings, inspirations, suggs] = await Promise.all([
                    query('Satisfaction'), query('WordCloud'), query('InterestApplication'),
                    query('TrainingInterest'), query('Inspiration'), query('Suggestion')
                ]);
                
                statusText.textContent = '数据获取成功！正在处理并生成报告...';
                
                const satisfactionSummary = processSatisfaction(satis);
                const wordCloudRaw = words.map(i => ({ Timestamp: i.createdAt.toLocaleString(), Word: i.get('word') }));
                const interestRaw = interests.flatMap(i => { const ts = i.createdAt.toLocaleString(); return i.get('selections').map(sel => ({ Timestamp: ts, Selection: sel })); });
                const trainingRaw = trainings.flatMap(i => { const ts = i.createdAt.toLocaleString(); return i.get('selections').map(sel => ({ Timestamp: ts, Selection: sel })); });
                const inspirationsRaw = inspirations.map(i => ({ Timestamp: i.createdAt.toLocaleString(), Inspiration: i.get('text') }));
                const suggestionsRaw = suggs.map(i => ({ Timestamp: i.createdAt.toLocaleString(), Suggestion: i.get('text') }));

                displayOnPage({ satisfactionSummary, interestRaw, trainingRaw });

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(satisfactionSummary, {header:["Option", "Count", "Percentage"]}), "Q1 Satisfaction");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(wordCloudRaw), "Q2 WordCloud");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(interestRaw), "Q3 App Interests");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(trainingRaw), "Q4 Training Interests");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inspirationsRaw), "Q5 Inspirations");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(suggestionsRaw), "Q6 Suggestions");
                
                // Set column widths
                wb.Sheets["Q1 Satisfaction"]['!cols'] = [{ wch: 20 }, { wch: 10 }, { wch: 15 }];
                wb.Sheets["Q2 WordCloud"]['!cols'] = [{ wch: 25 }, { wch: 50 }];
                wb.Sheets["Q3 App Interests"]['!cols'] = [{ wch: 25 }, { wch: 80 }];
                wb.Sheets["Q4 Training Interests"]['!cols'] = [{ wch: 25 }, { wch: 80 }];
                wb.Sheets["Q5 Inspirations"]['!cols'] = [{ wch: 25 }, { wch: 80 }];
                wb.Sheets["Q6 Suggestions"]['!cols'] = [{ wch: 25 }, { wch: 80 }];
                
                XLSX.writeFile(wb, "MBPTS_Tech_Journey_Feedback_Report.xlsx");
                
                statusText.textContent = `报告生成完毕！共处理 ${satis.length} 条投票。`;

            } catch (error) {
                console.error("处理失败:", error);
                statusText.textContent = '处理失败，请检查 LeanCloud 类名并查看控制台报错信息。';
            } finally {
                fetchBtn.disabled = false;
            }
        }
        
        function processSatisfaction(data) {
            const counts = { '非常棒': 0, '还不错': 0, '一般般': 0, '有待改进': 0 };
            data.forEach(item => { counts[item.get('vote')]++; });
            const total = data.length;
            const summaryData = Object.keys(counts).map(key => ({
                "Option": key, "Count": counts[key], "Percentage": total > 0 ? ((counts[key] / total) * 100).toFixed(1) + '%' : '0%'
            }));
            summaryData.push({ "Option": "", "Count": "", "Percentage": "" }); // spacer
            summaryData.push({ "Option": "Total", "Count": total, "Percentage": "100%" });
            return summaryData;
        }

        function displayOnPage(data) {
            document.querySelectorAll('.data-section').forEach(el => el.remove());

            const createSection = (title, headers, rows) => {
                const section = document.createElement('div');
                section.className = 'data-section';
                let tableHTML = `<h2>${title}</h2><table><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
                tableHTML += rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
                tableHTML += '</table>';
                container.appendChild(section);
            };

            createSection('Q1: 满意度汇总', ['选项', '票数', '百分比'], data.satisfactionSummary.map(r => [r.Option, r.Count, r.Percentage]));
            
            const interestCounts = data.interestRaw.reduce((acc, { Selection }) => { acc[Selection] = (acc[Selection] || 0) + 1; return acc; }, {});
            const sortedInterests = Object.entries(interestCounts).sort((a,b) => b[1] - a[1]);
            createSection('Q3: 热点应用排行', ['应用', '票数'], sortedInterests);

            const trainingCounts = data.trainingRaw.reduce((acc, { Selection }) => { acc[Selection] = (acc[Selection] || 0) + 1; return acc; }, {});
            const sortedTrainings = Object.entries(trainingCounts).sort((a,b) => b[1] - a[1]);
            createSection('Q4: 培训需求排行', ['方向', '票数'], sortedTrainings);
        }

        fetchBtn.addEventListener('click', generateReport);
    </script>
</body>
</html>
