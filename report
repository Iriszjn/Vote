<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBPTS Tech Journey - Feedback Report</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', 'Noto Sans SC', sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 40px;
        }
        .report-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-radius: 10px;
        }
        header {
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 30px;
            margin-bottom: 40px;
        }
        header h1 {
            font-size: 2.5rem;
            color: #1a237e;
            margin: 0;
        }
        header p {
            font-size: 1.1rem;
            color: #555;
            margin-top: 10px;
        }
        .key-metrics {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 50px;
            padding: 20px;
            background-color: #e8eaf6;
            border-radius: 8px;
        }
        .metric {
            flex: 1;
        }
        .metric-value {
            font-size: 2.8rem;
            font-weight: 700;
            color: #3f51b5;
        }
        .metric-label {
            font-size: 1rem;
            color: #333;
        }
        .report-section {
            margin-bottom: 50px;
        }
        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a237e;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        /* Bar Chart Styles */
        .chart-container { display: flex; flex-direction: column; gap: 1rem; width: 100%; }
        .bar-item { display: flex; align-items: center; gap: 15px; }
        .bar-label { flex: 0 0 30%; font-size: 1rem; color: #334155; }
        .bar-wrapper { flex-grow: 1; background-color: #e2e8f0; border-radius: 8px; }
        .bar-itself { height: 28px; border-radius: 8px; background: linear-gradient(90deg, #5c6bc0, #3f51b5); transition: width 0.5s ease-out; text-align: right; color: white; line-height: 28px; padding-right: 10px; box-sizing: border-box; font-size: 0.9em; }
        /* Word Cloud */
        #wordcloud-container { width: 100%; height: 400px; border: 1px solid #eee; border-radius: 8px; }
        /* "Others" section */
        .others-section {
            margin-top: 25px;
            padding: 15px;
            background-color: #fafafa;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .others-title { font-weight: bold; margin-bottom: 10px; }
        .others-list { list-style-type: disc; padding-left: 20px; margin: 0; }
        .others-list li { margin-bottom: 5px; }
        /* Qualitative Summary */
        .summary-block { margin-bottom: 25px; }
        .summary-block h4 { font-size: 1.2rem; color: #3f51b5; margin: 0 0 10px 0; }
        .summary-english { font-size: 1rem; line-height: 1.6; }
        .summary-chinese-quote { font-family: 'Noto Sans SC', sans-serif; font-size: 0.9rem; color: #666; background: #f7f7f7; padding: 10px; border-left: 3px solid #ccc; margin: 10px 0 0 0; }
        .placeholder { text-align: center; padding: 50px; color: #888; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
</head>
<body>
    <div class="report-container">
        <header>
            <h1>MBPTS Tech Journey - Feedback Report</h1>
            <p>A comprehensive summary of employee feedback for management review.</p>
        </header>

        <section class="key-metrics">
            <div class="metric">
                <div id="total-participants" class="metric-value">-</div>
                <div class="metric-label">Total Participants</div>
            </div>
            <div class="metric">
                <div id="positive-satisfaction" class="metric-value">- %</div>
                <div class="metric-label">Positive Satisfaction Rate<br>(Excellent + Good)</div>
            </div>
        </section>

        <!-- Q1: Satisfaction -->
        <section class="report-section">
            <h2 class="section-title">Q1. Overall Satisfaction Breakdown</h2>
            <div id="satisfaction-chart" class="chart-container"><div class="placeholder">Loading data...</div></div>
        </section>
        
        <!-- Q2: Word Cloud -->
        <section class="report-section">
            <h2 class="section-title">Q2. Key Themes in One Word</h2>
            <div id="wordcloud-container"><div class="placeholder">Loading data...</div></div>
        </section>

        <!-- Q3: Applications -->
        <section class="report-section">
            <h2 class="section-title">Q3. Most Eager-to-Try Applications</h2>
            <div id="interest-chart" class="chart-container"><div class="placeholder">Loading data...</div></div>
            <div id="interest-others" class="others-section" style="display: none;">
                <h4 class="others-title">"Other" Submissions:</h4>
                <ul id="interest-others-list" class="others-list"></ul>
            </div>
        </section>

        <!-- Q4: Training -->
        <section class="report-section">
            <h2 class="section-title">Q4. Top Demands for Future AI Training</h2>
            <div id="training-chart" class="chart-container"><div class="placeholder">Loading data...</div></div>
            <div id="training-others" class="others-section" style="display: none;">
                <h4 class="others-title">"Other" Submissions:</h4>
                <ul id="training-others-list" class="others-list"></ul>
            </div>
        </section>

        <!-- Q5: Inspirations -->
        <section class="report-section">
            <h2 class="section-title">Q5. Key Inspirations & New Ideas</h2>
            <div id="inspirations-summary"><div class="placeholder">Loading data...</div></div>
        </section>

        <!-- Q6: Suggestions -->
        <section class="report-section">
            <h2 class="section-title">Q6. Actionable Suggestions</h2>
            <div id="suggestions-summary"><div class="placeholder">Loading data...</div></div>
        </section>
    </div>

    <script src="//cdn.jsdelivr.net/npm/leancloud-storage/dist/av-live-query-min.js"></script>
    <script>
        AV.init({
            appId: "Slv3fGdSSxRZxOzM5la2ZCyD-gzGzoHsz",
            appKey: "XcUAt5yfUPWQlEpLBdXLcJHW",
            serverURL: "https://slv3fgds.lc-cn-n1-shared.com"
        });

        window.onload = async function generateReport() {
            try {
                const query = (className) => new AV.Query(className).limit(1000).find();
                const [satis, words, interests, trainings, inspirations, suggs] = await Promise.all([
                    query('Satisfaction'), query('WordCloud'), query('InterestApplication'),
                    query('TrainingInterest'), query('Inspiration'), query('Suggestion')
                ]);

                // Render all sections
                renderKeyMetrics(satis);
                renderSatisfaction(satis);
                renderWordCloud(words);
                renderRankedChoice('interest-chart', 'interest-others', interests);
                renderRankedChoice('training-chart', 'training-others', trainings);
                renderQualitativeSummary('inspirations-summary', inspirations, getInspirationThemes());
                renderQualitativeSummary('suggestions-summary', suggs, getSuggestionThemes());

            } catch (error) {
                console.error("Failed to generate report:", error);
                document.body.innerHTML = '<h1>Error: Failed to fetch data from the server. Please check the console for details.</h1>';
            }
        };

        function renderKeyMetrics(data) {
            const total = data.length;
            document.getElementById('total-participants').textContent = total;
            
            if (total > 0) {
                const positiveVotes = data.filter(i => i.get('vote') === '非常棒' || i.get('vote') === '还不错').length;
                const positiveRate = ((positiveVotes / total) * 100).toFixed(1);
                document.getElementById('positive-satisfaction').textContent = `${positiveRate} %`;
            } else {
                document.getElementById('positive-satisfaction').textContent = `0 %`;
            }
        }
        
        function renderSatisfaction(data) {
            const container = document.getElementById('satisfaction-chart');
            const counts = { '非常棒': 0, '还不错': 0, '一般般': 0, '有待改进': 0 };
            const labels = { '非常棒': 'Excellent', '还不错': 'Good', '一般般': 'Average', '有待改进': 'Needs Improvement' };
            data.forEach(item => { counts[item.get('vote')]++; });
            const total = data.length;
            
            if (total === 0) { container.innerHTML = '<div class="placeholder">No data available.</div>'; return; }
            container.innerHTML = '';
            
            Object.keys(counts).forEach(key => {
                const count = counts[key];
                const percentage = total > 0 ? (count / total) * 100 : 0;
                const el = document.createElement('div');
                el.className = 'bar-item';
                el.innerHTML = `
                    <div class="bar-label">${labels[key]} (${key})</div>
                    <div class="bar-wrapper">
                        <div class="bar-itself" style="width: ${percentage}%;">${count} votes (${percentage.toFixed(1)}%)</div>
                    </div>
                `;
                container.appendChild(el);
            });
        }
        
        function renderWordCloud(data) {
            const container = document.getElementById('wordcloud-container');
            const words = data.map(item => item.get('word')).filter(Boolean);
            if (words.length === 0) { container.innerHTML = '<div class="placeholder">No data available.</div>'; return; }
            const freq = words.reduce((acc, word) => { acc[word] = (acc[word] || 0) + 1; return acc; }, {});
            const list = Object.entries(freq).map(([text, weight]) => [text, weight * 10]);
            WordCloud(container, { list, gridSize: 10, weightFactor: 4, fontFamily: 'Roboto, Noto Sans SC', color: 'random-dark', backgroundColor: '#fff', minSize: 15 });
        }

        function renderRankedChoice(chartId, othersId, data) {
            const chartContainer = document.getElementById(chartId);
            const othersContainer = document.getElementById(othersId);
            const othersList = document.getElementById(othersId + '-list');

            const allSelections = data.flatMap(item => item.get('selections'));
            if (allSelections.length === 0) { chartContainer.innerHTML = '<div class="placeholder">No data available.</div>'; return; }

            const counts = allSelections.reduce((acc, sel) => { acc[sel] = (acc[sel] || 0) + 1; return acc; }, {});
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const maxCount = sorted.length > 0 ? sorted[0][1] : 0;
            
            chartContainer.innerHTML = '';
            othersList.innerHTML = '';
            let hasOthers = false;

            sorted.forEach(([label, count]) => {
                if (label.startsWith('其他:')) {
                    hasOthers = true;
                    const li = document.createElement('li');
                    li.textContent = label.substring(3).trim();
                    othersList.appendChild(li);
                } else {
                    const width = maxCount > 0 ? (count / maxCount) * 100 : 0;
                    const item = document.createElement('div');
                    item.className = 'bar-item';
                    item.innerHTML = `
                        <div class="bar-label" title="${label}">${label}</div>
                        <div class="bar-wrapper">
                             <div class="bar-itself" style="width: ${width}%;">${count} votes</div>
                        </div>
                    `;
                    chartContainer.appendChild(item);
                }
            });

            if(hasOthers) othersContainer.style.display = 'block';
        }
        
        function getInspirationThemes() {
            return [
                {
                    title: "Improving Workflow Efficiency & Automation",
                    keywords: ['效率', '自动', '简化', '流程', '节省时间'],
                    quotes: []
                },
                {
                    title: "Applying Specific Tools to Projects",
                    keywords: ['项目', '应用', '尝试', '工具', '结合'],
                    quotes: []
                },
                {
                    title: "New Perspectives & Strategic Thinking",
                    keywords: ['思考', '启发', '思路', '方向', '视野', '创新'],
                    quotes: []
                }
            ];
        }

        function getSuggestionThemes() {
             return [
                {
                    title: "Requests for More In-depth & Hands-on Sessions",
                    keywords: ['深入', '实战', '动手', '操作', 'workshop', '实践'],
                    quotes: []
                },
                {
                    title: "Suggestions for Future Topics",
                    keywords: ['主题', '课程', '分享', '希望有', '领域'],
                    quotes: []
                },
                {
                    title: "Feedback on Event Logistics & Format",
                    keywords: ['形式', '时间', '安排', '节奏', '互动'],
                    quotes: []
                }
            ];
        }

        function renderQualitativeSummary(containerId, data, themes) {
            const container = document.getElementById(containerId);
            const texts = data.map(item => item.get('text')).filter(Boolean);

            if (texts.length === 0) { container.innerHTML = '<div class="placeholder">No data available.</div>'; return; }

            texts.forEach(text => {
                let categorized = false;
                for (const theme of themes) {
                    for (const keyword of theme.keywords) {
                        if (text.includes(keyword)) {
                            theme.quotes.push(text);
                            categorized = true;
                            break;
                        }
                    }
                    if (categorized) break;
                }
            });

            container.innerHTML = '';
            themes.forEach(theme => {
                if (theme.quotes.length > 0) {
                    const block = document.createElement('div');
                    block.className = 'summary-block';
                    
                    let quotesHTML = '';
                    // Display up to 3 quotes as examples
                    theme.quotes.slice(0, 3).forEach(quote => {
                        quotesHTML += `<p class="summary-chinese-quote">"${quote}"</p>`;
                    });

                    block.innerHTML = `
                        <h4>${theme.title} (${theme.quotes.length} related comments)</h4>
                        <div class="summary-english">
                           Key takeaways include discussions on ${theme.keywords.join(', ')}. Participants expressed interest in these areas, with representative comments below.
                        </div>
                        ${quotesHTML}
                    `;
                    container.appendChild(block);
                }
            });
        }
    </script>
</body>
</html>
